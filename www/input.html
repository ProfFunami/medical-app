<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Security-Policy"
          content="default-src * data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
    <script src="components/loader.js"></script>
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
    <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js"></script>
    <script src="./contractInformation.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <script src="./aes.js"></script>
    <script src="./hospital.js"></script>
</head>
<body>
<script>
    const web3 = new Web3('wss://rinkeby.infura.io/ws/v3/cf93a80dccb7456d806de40695023f72');

    console.log(web3);
    const HospitalContractInstance = new web3.eth.Contract(HospitalContractABI, HospitalContractAddress);

    // ブラウザのローカルストレージから秘密鍵を読み込み
    const privateKey = localStorage.getItem('privateKey');

    if (privateKey == null) {
        alert("Please Input Your Private Key");
        location.href = '../common.html';
    }

    // 秘密鍵 => アドレス
    const account = web3.eth.accounts.privateKeyToAccount(privateKey);

    // イベントのキャッチ設定
    HospitalContractInstance.events.StartExamination({}, function (error, event) {
        console.log(event);
        if (event.returnValues.patientAddress == account.address) {
            $('#contractAddress').text("Examination Contract Address : " + event.returnValues.contractAddress);
        }
        localStorage.setItem("contractAddress", event.returnValues.contractAddress);
    });


    $(function () {
        $("button[name='size']").on("click", function (e) {
            e.preventDefault();
            const obj = {
                "name": $('#name').val(),
                "country": $('#country').val(),
                "language": $('#language').val(),
                "destination": $('#destination').val(),
                "work place": $('#work_place').val(),
                "length of stay": $('#length_of_stay').val(),
                "medical insurance YES": $('#medical_insurance_yes').val(),
                "medical insurance NO": $('#medical_insurance_no').val(),
                "method of payment": $('#method_of_paymnt').val(),
                "religious requests": $('#religious_requests').val(),
                "emergency contact": $('#emergency_contact').val(),
                "acquaintance": $('#acquaintance').val(),
                "others": $('#others').val()
            };
            //JSON化
            var jsonObj = JSON.stringify(obj, undefined, "\t");

            // 暗号化キー
            var txt_key = "0123456789ABCDEF0123456789ABCDEF";
            console.log('original_strngs: ' + jsonObj);
            var utf8_plain = CryptoJS.enc.Utf8.parse(jsonObj);
            // 暗号化
            var encrypted = CryptoJS.AES.encrypt(utf8_plain, txt_key);
            var encrypted_strings = txt_key + "," + encrypted.toString();

            //署名
            const source = encrypted_strings + "," + sign(jsonObj);
            console.log('source: ' + source);
            try {
                $('#qrcode').html("").qrcode({
                    width: 400,
                    height: 400,
                    text: source,
                });
            } catch (e) {
                $('#qrcode').html("").append("文字数オーバーです：<br>" + e);
            }
        })
    });

    $("#setMedicalCostButton").on("click", function (e) {
        e.preventDefault();
        var cost = $("#setMedicalCostInput").val();
        cost_sign = sign(String(cost));
        console.log(cost_sign);
        $('#setMedicalCostQrcode').html("").qrcode({
            width: 200,
            height: 200,
            text: cost_sign,
        });
    });
    const web3 = new Web3('wss://rinkeby.infura.io/ws/v3/cf93a80dccb7456d806de40695023f72');

    console.log(web3);
    const HospitalContractInstance = new web3.eth.Contract(HospitalContractABI, HospitalContractAddress);

    // ブラウザのローカルストレージから秘密鍵を読み込み
    const privateKey = localStorage.getItem('privateKey');

    if (privateKey == null) {
        alert("Please Input Your Private Key");
        location.href = '../common.html';
    }

    // 秘密鍵 => アドレス
    const account = web3.eth.accounts.privateKeyToAccount(privateKey);

    // イベントのキャッチ設定
    HospitalContractInstance.events.StartExamination({}, function (error, event) {
        console.log(event);
        if (event.returnValues.patientAddress == account.address) {
            $('#contractAddress').text("Examination Contract Address : " + event.returnValues.contractAddress);
        }
        localStorage.setItem("contractAddress", event.returnValues.contractAddress);
    });


    $(function () {
        $("button[name='size']").on("click", function (e) {
            e.preventDefault();
            const obj = {
                "name": $('#name').val(),
                "country": $('#country').val(),
                "language": $('#language').val(),
                "destination": $('#destination').val(),
                "work place": $('#work_place').val(),
                "length of stay": $('#length_of_stay').val(),
                "medical insurance YES": $('#medical_insurance_yes').val(),
                "medical insurance NO": $('#medical_insurance_no').val(),
                "method of payment": $('#method_of_paymnt').val(),
                "religious requests": $('#religious_requests').val(),
                "emergency contact": $('#emergency_contact').val(),
                "acquaintance": $('#acquaintance').val(),
                "others": $('#others').val()
            };
            //JSON化
            var jsonObj = JSON.stringify(obj, undefined, "\t");

            // 暗号化キー
            var txt_key = "0123456789ABCDEF0123456789ABCDEF";
            console.log('original_strngs: ' + jsonObj);
            var utf8_plain = CryptoJS.enc.Utf8.parse(jsonObj);
            // 暗号化
            var encrypted = CryptoJS.AES.encrypt(utf8_plain, txt_key);
            var encrypted_strings = txt_key + "," + encrypted.toString();

            //署名
            const source = encrypted_strings + "," + sign(jsonObj);
            console.log('source: ' + source);
            try {
                $('#qrcode').html("").qrcode({
                    width: 400,
                    height: 400,
                    text: source,
                });
            } catch (e) {
                $('#qrcode').html("").append("文字数オーバーです：<br>" + e);
            }
        })
    });

    $("#setMedicalCostButton").on("click", function (e) {
        e.preventDefault();
        var cost = $("#setMedicalCostInput").val();
        cost_sign = sign(String(cost));
        console.log(cost_sign);
        $('#setMedicalCostQrcode').html("").qrcode({
            width: 200,
            height: 200,
            text: cost_sign,
        });
    });
</script>



</body>
</html>